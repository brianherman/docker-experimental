# general
# user              www www;    ## Default: nobody
worker_processes      5;      ## Default: 1
# error_log             logs/error.log;
# pid                   logs/nginx.pid;
worker_rlimit_nofile  8192;

events {
  worker_connections  4096;   ## Default: 1024
}

http {
  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 30m;
   
  proxy_cache_path        /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=10m;
  proxy_temp_path         /var/tmp;
  include                 mime.types;
  default_type            application/octet-stream;
  sendfile                on;
  keepalive_timeout       65;

  gzip                    on;
  gzip_comp_level         6;
  gzip_vary               on;
  gzip_min_length         1000;
  gzip_proxied            any;
  gzip_types              text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_buffers            16 8k;

  # simple node high availability
 upstream node-upstream {
   least_conn;

   server node-1:8080 weight=10 max_fails=4 fail_timeout=15s;
   server node-2:8080 weight=10 max_fails=4 fail_timeout=15s;
   server node-3:8080 weight=10 max_fails=4 fail_timeout=15s;

   keepalive 64;
 }

  upstream applesite-upstream {
    least_conn;

    server node-6:8080 weight=10 max_fails=4 fail_timeout=15s;
    server node-7:8080 weight=10 max_fails=4 fail_timeout=15s;
    server node-8:8080 weight=10 max_fails=4 fail_timeout=15s;

    keepalive 64;
  }

  upstream bananasite-upstream {
    least_conn;

    server node-9:8080 weight=10 max_fails=4 fail_timeout=15s;
    server node-10:8080 weight=10 max_fails=4 fail_timeout=15s;
    server node-11:8080 weight=10 max_fails=4 fail_timeout=15s;

    keepalive 64;
  }

  upstream splunk-upstream {
    least_conn;

    server dockerland-splunk-1:8000 weight=10 max_fails=4 fail_timeout=15s;

    keepalive 64;
  }

  # simple caching. reverse proxy. load balancing.
  server {

    listen              80; 
    listen              443 ssl;

    root                /var/www/public/default;

    server_name         www.dockerland.com;
    
    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    auth_basic            "Restricted";
    auth_basic_user_file  /conf/passwords;

    proxy_http_version    1.1;
    proxy_set_header      Upgrade $http_upgrade;
    proxy_set_header      Connection 'upgrade';
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header      X-NginX-Proxy true;
    proxy_cache_bypass    $http_upgrade;

    proxy_set_header      X-Forwarded-Proto https;
    # proxy_redirect        off;

    # ~* is case insensitive
    # ~  is case sensitive
    # ^~ matcher (same as ~ ^)? 

    # serve static files.
    # location ~* ^/(app|lib|images|javascript|js|css|flash|media|static)/ {
    #   root                  /var/www/public/banana-site;
    #   access_log off;
    #   expires 1d;
    # }

    # proxy cache example
    # location ~* ^/(app|lib|images|javascript|js|css|flash|media|static)/ {
    #   proxy_cache           my_cache;
    #   proxy_pass            http://bananasite-upstream;
    #   access_log off;
    #   expires 1d;
    # }

    # global cache
    proxy_cache           my_cache;

    location ^~ /applesite {
      proxy_pass            http://applesite-upstream/;
    }

    # ^banana-site(.+)$

    location ^~ /banana-site {
      proxy_pass            http://bananasite-upstream/;
    }

    location ^~ /splunk {
      proxy_pass            http://splunk-upstream/;
    }

    location / {
      try_files $uri $uri/ =404;  
    }
  }
}